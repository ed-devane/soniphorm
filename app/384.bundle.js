/*! For license information please see 384.bundle.js.LICENSE.txt */
"use strict";(self.webpackChunkesp32_patcher=self.webpackChunkesp32_patcher||[]).push([[384],{384:(e,n,r)=>{function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t(e)}function o(e,n){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,n){if(e){if("string"==typeof e)return i(e,n);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?i(e,n):void 0}}(e))||n&&e&&"number"==typeof e.length){r&&(e=r);var t=0,o=function(){};return{s:o,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){c=!0,a=e},f:function(){try{s||null==r.return||r.return()}finally{if(c)throw a}}}}function i(e,n){(null==n||n>e.length)&&(n=e.length);for(var r=0,t=Array(n);r<n;r++)t[r]=e[r];return t}function a(e){if(null!=e){var n=e["function"==typeof Symbol&&Symbol.iterator||"@@iterator"],r=0;if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length))return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}throw new TypeError(t(e)+" is not iterable")}function s(){var e,n,r="function"==typeof Symbol?Symbol:{},t=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function i(r,t,o,i){var s=t&&t.prototype instanceof u?t:u,f=Object.create(s.prototype);return c(f,"_invoke",function(r,t,o){var i,s,c,u=0,f=o||[],l=!1,h={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(n,r){return i=n,s=0,c=e,h.n=r,a}};function p(r,t){for(s=r,c=t,n=0;!l&&u&&!o&&n<f.length;n++){var o,i=f[n],p=h.p,d=i[2];r>3?(o=d===t)&&(c=i[(s=i[4])?5:(s=3,3)],i[4]=i[5]=e):i[0]<=p&&((o=r<2&&p<i[1])?(s=0,h.v=t,h.n=i[1]):p<d&&(o=r<3||i[0]>t||t>d)&&(i[4]=r,i[5]=t,h.n=d,s=0))}if(o||r>1)return a;throw l=!0,t}return function(o,f,d){if(u>1)throw TypeError("Generator is already running");for(l&&1===f&&p(f,d),s=f,c=d;(n=s<2?e:c)||!l;){i||(s?s<3?(s>1&&(h.n=-1),p(s,c)):h.n=c:h.v=c);try{if(u=2,i){if(s||(o="next"),n=i[o]){if(!(n=n.call(i,c)))throw TypeError("iterator result is not an object");if(!n.done)return n;c=n.value,s<2&&(s=0)}else 1===s&&(n=i.return)&&n.call(i),s<2&&(c=TypeError("The iterator does not provide a '"+o+"' method"),s=1);i=e}else if((n=(l=h.n<0)?c:r.call(t,h))!==a)break}catch(n){i=e,s=1,c=n}finally{u=1}}return{value:n,done:l}}}(r,o,i),!0),f}var a={};function u(){}function f(){}function l(){}n=Object.getPrototypeOf;var h=[][t]?n(n([][t]())):(c(n={},t,function(){return this}),n),p=l.prototype=u.prototype=Object.create(h);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,l):(e.__proto__=l,c(e,o,"GeneratorFunction")),e.prototype=Object.create(p),e}return f.prototype=l,c(p,"constructor",l),c(l,"constructor",f),f.displayName="GeneratorFunction",c(l,o,"GeneratorFunction"),c(p),c(p,o,"Generator"),c(p,t,function(){return this}),c(p,"toString",function(){return"[object Generator]"}),(s=function(){return{w:i,m:d}})()}function c(e,n,r,t){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}c=function(e,n,r,t){function i(n,r){c(e,n,function(e){return this._invoke(n,r,e)})}n?o?o(e,n,{value:r,enumerable:!t,configurable:!t,writable:!t}):e[n]=r:(i("next",0),i("throw",1),i("return",2))},c(e,n,r,t)}function u(e,n,r,t,o,i,a){try{var s=e[i](a),c=s.value}catch(e){return void r(e)}s.done?n(c):Promise.resolve(c).then(t,o)}function f(e){return function(){var n=this,r=arguments;return new Promise(function(t,o){var i=e.apply(n,r);function a(e){u(i,t,o,a,s,"next",e)}function s(e){u(i,t,o,a,s,"throw",e)}a(void 0)})}}function l(e,n){for(var r=0;r<n.length;r++){var t=n[r];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,h(t.key),t)}}function h(e){var n=function(e){if("object"!=t(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,"string");if("object"!=t(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==t(n)?n:n+""}r.r(n),r.d(n,{default:()=>d});var p=5e3,d=function(){return e=function e(){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this._port=null,this._reader=null,this._readableStreamClosed=null,this._writableStreamClosed=null,this._writer=null,this._responseBuffer="",this._responseResolve=null,this._onData=null,this._emitPos=0},n=[{key:"setOnData",value:function(e){this._onData=e}},{key:"connect",value:(w=f(s().m(function e(n){var r,t,o;return s().w(function(e){for(;;)switch(e.n){case 0:if(!this._port){e.n=1;break}throw new Error("Already connected. Disconnect first.");case 1:if(o=n){e.n=3;break}return e.n=2,navigator.serial.requestPort({filters:[{usbVendorId:12346},{usbVendorId:4292},{usbVendorId:6790},{usbVendorId:1027}]});case 2:o=e.v;case 3:return this._port=o,e.n=4,this._port.open({baudRate:115200});case 4:r=new TextDecoderStream,this._readableStreamClosed=this._port.readable.pipeTo(r.writable),this._reader=r.readable.getReader(),t=new TextEncoderStream,this._writableStreamClosed=t.readable.pipeTo(this._port.writable),this._writer=t.writable.getWriter(),this._startReading();case 5:return e.a(2)}},e,this)})),function(e){return w.apply(this,arguments)})},{key:"disconnect",value:(v=f(s().m(function e(){var n;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,!this._reader){e.n=3;break}return e.n=1,this._reader.cancel();case 1:return e.n=2,this._readableStreamClosed.catch(function(){});case 2:this._reader=null;case 3:if(!this._writer){e.n=6;break}return e.n=4,this._writer.close();case 4:return e.n=5,this._writableStreamClosed.catch(function(){});case 5:this._writer=null;case 6:if(!this._port){e.n=8;break}return e.n=7,this._port.close();case 7:this._port=null;case 8:e.n=10;break;case 9:e.p=9,n=e.v,console.warn("Disconnect cleanup:",n.message),this._port=null,this._reader=null,this._writer=null;case 10:return e.a(2)}},e,this,[[0,9]])})),function(){return v.apply(this,arguments)})},{key:"isConnected",value:function(){return null!==this._port&&null!==this._reader}},{key:"tryAutoConnect",value:(b=f(s().m(function e(){var n;return s().w(function(e){for(;;)switch(e.p=e.n){case 0:if("serial"in navigator){e.n=1;break}return e.a(2,!1);case 1:return e.n=2,navigator.serial.getPorts();case 2:if(!((n=e.v).length>0)){e.n=6;break}return e.p=3,e.n=4,this.connect(n[0]);case 4:return e.a(2,!0);case 5:return e.p=5,e.v,e.a(2,!1);case 6:return e.a(2,!1)}},e,this,[[3,5]])})),function(){return b.apply(this,arguments)})},{key:"uploadPatch",value:(_=f(s().m(function e(n,r,t){var o,i,a,c,u,f,l;return s().w(function(e){for(;;)switch(e.n){case 0:if(this.isConnected()){e.n=1;break}throw new Error("Not connected");case 1:return o=t||function(){},i=r||function(){},a=JSON.stringify(n),o("Patch size: ".concat(a.length," bytes")),o("Sending PATCH_START..."),e.n=2,this._send("PATCH_START\n");case 2:return e.n=3,this._waitForResponse("PATCH_READY",p);case 3:if(e.v){e.n=4;break}throw new Error("Device did not respond with PATCH_READY. Is GenRuntime running?");case 4:for(o("Device ready (PATCH_READY received)"),c=[],u=0;u<a.length;u+=180)c.push(a.substring(u,u+180));o("Sending ".concat(c.length," chunks (").concat(a.length," bytes)...")),f=0;case 5:if(!(f<c.length)){e.n=10;break}return e.n=6,this._send("CHUNK:".concat(c[f],"\n"));case 6:return e.n=7,this._waitForResponse("CHUNK_OK",p);case 7:if(e.v){e.n=8;break}throw new Error("Chunk ".concat(f+1,"/").concat(c.length," not acknowledged (timeout)"));case 8:i(Math.round((f+1)/c.length*100));case 9:f++,e.n=5;break;case 10:return o("Sending PATCH_END..."),e.n=11,this._send("PATCH_END\n");case 11:return e.n=12,this._waitForResponse(["PATCH_OK","PATCH_ERROR"],1e4);case 12:if(l=e.v){e.n=13;break}throw new Error("No response after PATCH_END (timeout)");case 13:if(!l.includes("PATCH_ERROR")){e.n=14;break}throw new Error("Device error: ".concat(l));case 14:o("Upload complete - device confirmed PATCH_OK"),i(100);case 15:return e.a(2)}},e,this)})),function(e,n,r){return _.apply(this,arguments)})},{key:"uploadFile",value:(d=f(s().m(function e(n,r,t,o){var i,c,u,f,l,h,p,d,_,b,v,w,y,m,E,k,R,g,S,F,T=this;return s().w(function(e){for(;;)switch(e.n){case 0:if(this.isConnected()){e.n=1;break}throw new Error("Not connected");case 1:i=o||function(){},c=t||function(){},u=r.byteLength,f=2048,i("File: ".concat(n," (").concat(u," bytes)")),l=null,h=3,p=s().m(function e(){var r;return s().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,T._send("FILE_START:".concat(n,":").concat(u,"\n"));case 1:return e.n=2,T._waitForResponse(["FILE_READY","FILE_ERROR"],1e4);case 2:if(!(l=e.v)){e.n=3;break}return e.a(2,1);case 3:return r=1e3*(d+1),i("FILE_START retry ".concat(d+1,"/").concat(h," (waiting ").concat(r,"ms)...")),e.n=4,new Promise(function(e){return setTimeout(e,r)});case 4:return e.a(2)}},e)}),d=0;case 2:if(!(d<h)){e.n=5;break}return e.d(a(p()),3);case 3:if(!e.v){e.n=4;break}return e.a(3,5);case 4:d++,e.n=2;break;case 5:if(l&&!l.includes("FILE_ERROR")){e.n=6;break}throw new Error(l||"Device did not respond to FILE_START after ".concat(h," attempts"));case 6:i("Device ready for file transfer"),_=new Uint8Array(r),b=0,v=0,w=Math.ceil(u/f);case 7:if(!(b<u)){e.n=17;break}for(y=Math.min(b+f,u),m=_.slice(b,y),E="",k=0;k<m.length;k++)E+=String.fromCharCode(m[k]);R=btoa(E),g=null,S=0;case 8:if(!(S<3)){e.n=13;break}return e.n=9,this._send("FCHUNK:".concat(R,"\n"));case 9:return e.n=10,this._waitForResponse(["FCHUNK_OK","FCHUNK_ERROR"],15e3);case 10:if(!(g=e.v)||g.includes("FCHUNK_ERROR")){e.n=11;break}return e.a(3,13);case 11:if(!(S<2)){e.n=12;break}return i("Chunk ".concat(v+1," retry ").concat(S+1,"/3...")),e.n=12,new Promise(function(e){return setTimeout(e,500)});case 12:S++,e.n=8;break;case 13:if(g&&!g.includes("FCHUNK_ERROR")){e.n=15;break}return e.n=14,this._send("FILE_ABORT\n");case 14:throw new Error("Chunk ".concat(v+1,"/").concat(w," failed after 3 attempts: ").concat(g||"timeout"));case 15:return b=y,v++,c(Math.round(b/u*100)),e.n=16,new Promise(function(e){return setTimeout(e,0)});case 16:e.n=7;break;case 17:return e.n=18,this._send("FILE_END\n");case 18:return e.n=19,this._waitForResponse(["FILE_OK","FILE_ERROR"],1e4);case 19:if((F=e.v)&&!F.includes("FILE_ERROR")){e.n=20;break}throw new Error(F||"No response after FILE_END");case 20:i("Upload complete: ".concat(n)),c(100);case 21:return e.a(2)}},e,this)})),function(e,n,r,t){return d.apply(this,arguments)})},{key:"uploadFiles",value:(h=f(s().m(function e(n,r,t){var o,i,c,u,f,l=this;return s().w(function(e){for(;;)switch(e.n){case 0:return i=r||function(){},(o=t||function(){})("Uploading ".concat(n.length," file(s) to SD card...")),c=Math.floor(Date.now()/1e3),e.n=1,this._send("TIME_SET:".concat(c,"\n"));case 1:return e.n=2,this._waitForResponse("TIME_OK",p);case 2:u=s().m(function e(r){var o;return s().w(function(e){for(;;)switch(e.n){case 0:return o=n[r],e.n=1,l.uploadFile(o.name,o.data,function(e){return i({file:o.name,fileIndex:r,fileCount:n.length,percent:e})},t);case 1:if(!(r<n.length-1)){e.n=2;break}return e.n=2,new Promise(function(e){return setTimeout(e,1500)});case 2:return e.a(2)}},e)}),f=0;case 3:if(!(f<n.length)){e.n=5;break}return e.d(a(u(f)),4);case 4:f++,e.n=3;break;case 5:o("All ".concat(n.length," file(s) uploaded successfully"));case 6:return e.a(2)}},e,this)})),function(e,n,r){return h.apply(this,arguments)})},{key:"sendCommand",value:(u=f(s().m(function e(n){return s().w(function(e){for(;;)switch(e.n){case 0:if(this.isConnected()){e.n=1;break}throw new Error("Not connected");case 1:return e.n=2,this._send(n+"\n");case 2:return e.a(2)}},e,this)})),function(e){return u.apply(this,arguments)})},{key:"listDirectory",value:(c=f(s().m(function e(){var n,r,t,o,i,a,c=arguments;return s().w(function(e){for(;;)switch(e.n){case 0:if(n=c.length>0&&void 0!==c[0]?c[0]:"/",this.isConnected()){e.n=1;break}throw new Error("Not connected");case 1:return e.n=2,this._send("LS ".concat(n,"\n"));case 2:return e.n=3,this._waitForResponse(["LS_START","LS_ERROR"],1e4);case 3:if((r=e.v)&&!r.includes("LS_ERROR")){e.n=4;break}throw new Error(r||"No response to LS command");case 4:t=[],o=Date.now()+1e4;case 5:if(!(Date.now()<o)){e.n=9;break}return e.n=6,this._waitForResponse(["F:","D:","LS_END"],3e3);case 6:if(i=e.v){e.n=7;break}return e.a(3,9);case 7:if(!i.includes("LS_END")){e.n=8;break}return e.a(3,9);case 8:i.startsWith("F:")?(a=i.substring(2).split(":"),t.push({name:a[0],size:parseInt(a[1])||0,type:"file"})):i.startsWith("D:")&&t.push({name:i.substring(2),size:0,type:"directory"}),e.n=5;break;case 9:return e.a(2,t)}},e,this)})),function(){return c.apply(this,arguments)})},{key:"downloadFile",value:(i=f(s().m(function e(n,r){var t,o,i,a,c,u,f,l,h,p,d,_,b,v,w,y,m,E,k;return s().w(function(e){for(;;)switch(e.n){case 0:if(this.isConnected()){e.n=1;break}throw new Error("Not connected");case 1:return t=r||function(){},e.n=2,this._send("FILE_SEND ".concat(n,"\n"));case 2:return e.n=3,this._waitForResponse(["FSEND_START","FSEND_ERROR"],1e4);case 3:if((o=e.v)&&!o.includes("FSEND_ERROR")){e.n=4;break}throw new Error(o||"No response to FILE_SEND command");case 4:i=o.replace(/\r/g,"").split(":"),a=parseInt(i[2])||0,c=[],u=0,f=6e4;case 5:return e.n=6,this._waitForResponse(["FSCHUNK:","FSEND_END"],f);case 6:if(l=e.v){e.n=7;break}throw new Error("Download timeout");case 7:if(!l.includes("FSEND_END")){e.n=8;break}return e.a(3,9);case 8:for(h=l.indexOf(":",8),p=l.substring(h+1),d=atob(p),_=new Uint8Array(d.length),b=0;b<d.length;b++)_[b]=d.charCodeAt(b);c.push(_),u+=_.length,a>0&&t(Math.min(100,Math.round(u/a*100))),e.n=5;break;case 9:for(v=c.reduce(function(e,n){return e+n.length},0),w=new Uint8Array(v),y=0,m=0,E=c;m<E.length;m++)k=E[m],w.set(k,y),y+=k.length;return t(100),e.a(2,w.buffer)}},e,this)})),function(e,n){return i.apply(this,arguments)})},{key:"deleteFile",value:(t=f(s().m(function e(n){var r;return s().w(function(e){for(;;)switch(e.n){case 0:if(this.isConnected()){e.n=1;break}throw new Error("Not connected");case 1:return e.n=2,this._send("FILE_DELETE ".concat(n,"\n"));case 2:return e.n=3,this._waitForResponse(["FILE_DELETED","FDEL_ERROR"],1e4);case 3:if((r=e.v)&&!r.includes("FDEL_ERROR")){e.n=4;break}throw new Error(r||"No response to FILE_DELETE command");case 4:return e.a(2,r)}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"_send",value:(r=f(s().m(function e(n){return s().w(function(e){for(;;)switch(e.n){case 0:if(this._writer){e.n=1;break}throw new Error("Writer not available");case 1:return e.n=2,this._writer.write(n);case 2:return e.a(2)}},e,this)})),function(e){return r.apply(this,arguments)})},{key:"_startReading",value:function(){var e=this,n=function(){var n=f(s().m(function n(){var r,t,o;return s().w(function(n){for(;;)switch(n.p=n.n){case 0:n.p=0;case 1:if(!e._reader){n.n=4;break}return n.n=2,e._reader.read();case 2:if(r=n.v,t=r.value,!r.done){n.n=3;break}return n.a(3,4);case 3:t&&(e._responseBuffer+=t,e._emitLines(),e._responseResolve&&e._checkResponse()),n.n=1;break;case 4:n.n=6;break;case 5:n.p=5,"TypeError"===(o=n.v).name||o.message.includes("cancelled")||console.error("Serial read error:",o);case 6:return n.a(2)}},n,null,[[0,5]])}));return function(){return n.apply(this,arguments)}}();n()}},{key:"_emitLines",value:function(){if(this._onData){for(var e=this._emitPos;;){var n=this._responseBuffer.indexOf("\n",e);if(-1===n)break;var r=this._responseBuffer.substring(e,n).trim();r&&this._onData(r),e=n+1}this._emitPos=e}}},{key:"_checkResponse",value:function(){if(this._responseResolve){var e,n=this._responseResolve,r=n.patterns,t=n.resolve,i=o(r);try{for(i.s();!(e=i.n()).done;){var a=e.value,s=this._responseBuffer.indexOf(a);if(-1!==s){var c=this._responseBuffer.indexOf("\n",s),u=(-1!==c?this._responseBuffer.substring(s,c):this._responseBuffer.substring(s)).replace(/\r/g,""),f=-1!==c?c+1:this._responseBuffer.length;return this._responseBuffer=this._responseBuffer.substring(f),this._emitPos=Math.max(0,this._emitPos-f),this._responseResolve=null,void t(u)}}}catch(e){i.e(e)}finally{i.f()}}}},{key:"_waitForResponse",value:function(e,n){var r=this;"string"==typeof e&&(e=[e]);var t,i=o(e);try{for(i.s();!(t=i.n()).done;){var a=t.value,s=this._responseBuffer.indexOf(a);if(-1!==s){var c=this._responseBuffer.indexOf("\n",s),u=(-1!==c?this._responseBuffer.substring(s,c):this._responseBuffer.substring(s)).replace(/\r/g,""),f=-1!==c?c+1:this._responseBuffer.length;return this._responseBuffer=this._responseBuffer.substring(f),this._emitPos=Math.max(0,this._emitPos-f),Promise.resolve(u)}}}catch(e){i.e(e)}finally{i.f()}return new Promise(function(t){var o=setTimeout(function(){r._responseResolve=null,t(null)},n);r._responseResolve={patterns:e,resolve:function(e){clearTimeout(o),t(e)}}})}}],n&&l(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,n,r,t,i,c,u,h,d,_,b,v,w}()}}]);